Metadl - NSIS 的 Metalink 下载插件
版权所有 (c) 2007 Hampus Wessman (hw@vox.nu)
文档翻译：水晶石
-------------------------------------------------

使用 NSIS 插件
------------------

在使用插件之前，NSIS 必须能够找到 dll 文件。一种方法是将其放置在 NSIS 的插件目录中。这样可以使您计算机上构建的所有安装程序都能使用 metadl。另一种方法（我更喜欢的方法）是将其放置在当前安装程序的特定目录中，然后在您的 NSIS 脚本中添加一行代码，告诉 NSIS 查找此目录。例如，您可以创建一个名为 "plugins" 的子目录，并将以下行添加到您的 NSIS 脚本中：

!addplugindir "plugins"

用法
-----

metadl:download [选项] [URL] 本地文件

返回值被推送到堆栈上：

如果取消，则为 "cancel"
如果成功，则为 "success"
否则，为描述错误的错误字符串
如果不想显示进度窗口，请使用 metadl::download_quiet（不建议，因为那样无法取消下载）。

选项
-------

/RETRYTIME=5（重试之间的秒数；默认值=5）
/MAXTRIES=0（最大尝试次数；0=无限，1=无重试，...；默认值=0）
/HASHTRIES=0（校验和失败时的最大尝试次数，作为最大尝试次数；默认值=0）

/MD5 the-hash（使用此哈希验证下载；默认情况下不使用 md5）
/SHA1 the-hash（使用此哈希验证下载；默认情况下不使用 sha1）
md5 和 sha1 可以同时使用！

/CHECK（仅检查哈希值，不会下载任何内容；默认情况下禁用）

/MIRRORS=2 url1 url2（添加这些镜像。您仍然需要一个 "普通" URL，因此请为其保留一个镜像！）

/PROXY proxy.whatever.com
/PROXY proxy.whatever.com:8080

还可以翻译插件（未记录；与 NSISdl 不兼容！）并从 NSISdl 设置所有其他选项（无论如何都未使用）。

本地文件和哈希检查
---------------------------

如果不输入 URL，则插件将不会尝试下载文件。如果要使用本地 metalink，则此功能很有用，它将被解析并用于下载。仍然会检查哈希值（如果存在），如果哈希值不匹配，则会返回错误（而不是尝试下载文件）。如果不想下载 metalink 中找到的文件，则可以添加选项 /CHECK（参见上文）。仍然会解析 Metalink 并检查其中描述的所有文件，但在尝试下载其中任何一个文件时将返回错误。当哈希检查失败或文件不存在时，将返回 "文件检查失败"。

行为
--------------

插件首先查找本地文件。如果存在，则检查哈希值，如果没有失败，则完成！否则，旧文件将被删除（如果存在），然后查找名为 local-file.partial 的文件。如果有一个，则继续在文件末尾，否则将创建一个。然后开始下载。镜像将随机选择开始，但错误和最后测试的顺序会被记住。一段时间后，它会选择尝试的 "最佳" 服务器。我不会详细说明这一点，但它运行得相当好。
如果发生错误，则会更新关于镜像的信息（在内存中）并检查是否应该进行更多重试（取决于 'max tries'）。这是总尝试次数（而不是每个镜像）。下载文件后，将检查校验和。如果文件无法验证，则会删除文件并重新开始进程（取决于 'hash tries'）。如果文件正确，则将其重命名为 'local-file'。

如果下载的文件以 ".metalink" 结尾，那么它将被解析，如果它是一个 metalink 文件，则将按上述描述下载 metalink 中描述的所有文件到与 metalink 相同的目录中。如果其中任何文件也是 metalink，则不会解析它们！

如果返回的不是 "cancel" 或 "success"，则始终会返回错误消息，解释出了什么问题！

编译插件
--------------------

我将在这里描述如何在 Ubuntu 中交叉编译插件。在 Windows 中编译它更复杂。只需按照以下简单步骤操作：

1.确保已安装 mingw32 包，否则运行 "sudo apt-get install mingw32"

2.运行 "make prerequisites" 下载 expat 和 libcurl。

3.然后运行 "make" 编译插件。

这将编译 metadl 及其依赖项。您将在子目录 "bin" 中找到二进制文件（即 metadl.dll）。

如果您使用的平台不是 Ubuntu，则可能需要对构建过程进行一些调整。此处包含的 makefile 仅用于与 Ubuntu 配合使用。这不是很好，但另一方面，应该很容易进行必要的更改...